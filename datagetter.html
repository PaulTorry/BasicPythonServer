<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Hosted datalogger program v0.11</title>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>

    <button onclick="getData()">Collect Batch</button>
    <button onclick="start()">Collect Run</button>
    <button onclick="downloadAll()">Download Saved data</button>

    <label for="ip">IP</label>
   <input type="text" id="ip" name="ip" value="http://192.168.178.187:8080">
   <label for="ip">delay</label>
   <input type="text" id="delay" name="delay" value="10" size="1">
   <label for="ip">batch</label>
   <input type="text" id="batch" name="batch" value="1" size="1">

   <canvas  width="1000" height="500" id= "graph"></canvas>
   
   <table id="dataTable"></table> 

  </body>

  <script>
        
    let distances = []
    let times = []
    let dataTable = document.getElementById("dataTable")


    async function start(){
      //console.log("Starting run")
      const url = document.getElementById("ip").value + "/startRun"
      //console.log("Starting run:   ", url);
      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`Response status: ${response.status}`);
        }
        const json = await response.text();
       
        // console.log(json);
      } catch (error) {
        console.error(error.message);
      }
      getData(8)
    }

    async function getData(remaingReadings = 0) {
      //console.log("getting current data");
      const url = document.getElementById("ip").value + "/data?x" + document.getElementById("batch").value +"y" + document.getElementById("delay").value  + "z"
      console.log("getting current data:   ", url);
      
      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`Response status: ${response.status}`);
        }
        const json = await response.text();
        console.log(json);
        line = JSON.parse(json)
        //console.log(line.distances);
        distances = line.distances
        times = line.times.map(Number) //t => Number(t) - Number(times[0]))
        times = 
        displayData(times, distances)


      } catch (error) {
        console.error(error.message);
      }

      if (remaingReadings > 0){
        //sleep(1).then(() => { getData(remaingReadings -1) });
        getData(remaingReadings -1)
      }
      //butt()
    }


    function displayData(t, d){
      let tt = times.map(t => Math.floor((t-times[0])*1000))
      let timesAndDistances = times.map((v, i) => [tt[i], d[i]]) 
        //console.log(distances, times);

        
        drawGraph(tt, distances)

        let timesAndDistancesTable = timesAndDistances.map(v => '<tr><td>'+ v[0] + '</td><td>' + v[1] +'</td></tr>')
        console.log(timesAndDistancesTable.join(""));
        

        dataTable.innerHTML = '<tr><th>time, t /s</th><th>distance, x /m</th></tr>' + timesAndDistancesTable.join("")
    }


    async function downloadAll() {
      //console.log("Download all");
      const url = document.getElementById("ip").value + "/allData"
      console.log("Download all:  ",   url);
      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`Response status: ${response.status}`);
        }
        const json = await response.text();
        console.log(json);
        

      } catch (error) {
        console.error(error.message);
      }
    }


    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    function drawGraph( times, distances, minX = 6000, minY = 2000){
    ctx = document.getElementById('graph').getContext('2d')
    ctx.clearRect(0,0,1000, 500)
    ctx.moveTo (times[0]/10, distances[0]/2)
    
    // ctx.beginPath();
    // ctx.moveTo(75, 50);
    // ctx.lineTo(100, 75);
    // ctx.lineTo(100, 25);
    // ctx.fill();

    ctx.beginPath()
      times.forEach((t,i) => {
        ctx.lineTo(t/5, 500 - distances[i]/10)
      });
      ctx.stroke()

    }

        </script>
</html>